<!DOCTYPE html>
<!-- Tambahkan class scroll-smooth untuk scrolling yang lebih halus -->
<html lang="id" class="scroll-smooth">
<head>
    <meta charset="UTF-M">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Ruang Pulih</title>
    <!-- 1. Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. Memuat Chart.js untuk grafik -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <!-- 3. Konfigurasi warna pastel kustom untuk Tailwind -->
    <script>
        tailwind.config = {
            // Aktifkan dark mode menggunakan class
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'pastel-bg': '#F8F9FA', // Latar belakang utama
                        'pastel-card': '#FFFFFF', // Kartu
                        'pastel-primary': '#a0c4ff', // Biru muda
                        'pastel-secondary': '#b6e2d3', // Hijau mint
                        'pastel-accent': '#ffcda3', // Peach
                        'pastel-warn': '#fdffb6', // Kuning muda
                        'pastel-danger': '#ffadad', // Merah muda
                        'text-primary': '#212529',
                        'text-secondary': '#6c757d',
                        
                        // Warna untuk Dark Mode
                        'dark-bg': '#1a202c',
                        'dark-card': '#2d3748',
                        'dark-text-primary': '#e2e8f0',
                        'dark-text-secondary': '#a0aec0',
                    }
                }
            }
        }
    </script>
    <style>
        /* Style tambahan untuk scrollbar yang lebih tipis */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #a0aec0; }
        
        /* Style untuk dark mode scrollbar */
        .dark ::-webkit-scrollbar-thumb { background: #4a5568; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #718096; }

        /* Animasi kustom untuk kartu */
        .card-hover {
            transition: all 0.3s ease-in-out;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="bg-pastel-bg text-text-primary dark:bg-dark-bg dark:text-dark-text-primary font-sans antialiased transition-colors duration-300">

    <div class="flex h-screen">
        <!-- ===== SIDEBAR (Navigasi) ===== -->
        <aside class="w-64 bg-pastel-card dark:bg-dark-card shadow-lg flex-shrink-0 hidden md:flex flex-col">
            <div class="flex items-center justify-center h-20 shadow-sm dark:border-b dark:border-gray-700">
                <h1 class="text-2xl font-bold text-pastel-primary">Ruang Pulih</h1>
            </div>
            <nav class="flex-1 p-6 space-y-4 overflow-y-auto">
                <h3 class="text-xs font-semibold text-text-secondary dark:text-dark-text-secondary uppercase tracking-wider">Daftar Pasien</h3>
                <ul class="space-y-2">
                    <li><a href="#" class="flex items-center p-3 rounded-lg text-text-secondary dark:text-dark-text-secondary hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-200">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                        USER-VR-451A
                    </a></li>
                    <!-- Pasien Aktif -->
                    <li class="bg-blue-100 dark:bg-blue-900 rounded-lg">
                        <a href="#" class="flex items-center p-3 rounded-lg text-blue-700 dark:text-blue-300 font-semibold">
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                            USER-VR-882B
                        </a>
                    </li>
                    <li><a href="#" class="flex items-center p-3 rounded-lg text-text-secondary dark:text-dark-text-secondary hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-200">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                        USER-VR-912C
                    </a></li>
                </ul>
            </nav>
        </aside>

        <!-- ===== KONTEN UTAMA ===== -->
        <main class="flex-1 flex flex-col overflow-hidden">
            <!-- Header Konten -->
            <header class="h-20 bg-pastel-card dark:bg-dark-card shadow-sm dark:border-b dark:border-gray-700 flex-shrink-0 flex items-center justify-between px-6">
                <h2 class="text-xl font-semibold dark:text-dark-text-primary">Ruang Pulih</h2>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-text-secondary dark:text-dark-text-secondary">Vansen Danuarta, M. Psi</span>
                    <img class="w-10 h-10 rounded-full" src="https://placehold.co/100x100/a0c4ff/FFFFFF?text=DV" alt="Avatar Psikolog">
                    <!-- TOMBOL DARK MODE TOGGLE -->
                    <button id="theme-toggle" class="p-2 rounded-full text-text-secondary dark:text-dark-text-secondary hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none transition-colors duration-200">
                        <svg id="theme-icon-sun" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                        <svg id="theme-icon-moon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                    </button>
                </div>
            </header>

            <!-- Area Grid Dashboard Utama -->
            <div class="flex-1 p-6 overflow-y-auto">
                <div class="grid grid-cols-1 md:grid-cols-12 gap-6">

                    <!-- POIN 1: Informasi Pengguna (Non-Identifikasi) -->
                    <div class="md:col-span-4 bg-pastel-card dark:bg-dark-card p-6 rounded-2xl shadow-lg card-hover">
                        <h3 class="text-lg font-semibold mb-4 text-pastel-primary">Informasi Pengguna</h3>
                        <ul class="space-y-3">
                            <li class="flex justify-between">
                                <span class="text-text-secondary dark:text-dark-text-secondary">ID Pengguna:</span>
                                <span class="font-medium text-text-primary dark:text-dark-text-primary">USER-VR-882B</span>
                            </li>
                            <li class="flex justify-between">
                                <span class="text-text-secondary dark:text-dark-text-secondary">Kelompok:</span>
                                <span class="font-medium bg-pastel-secondary text-green-800 px-2 py-0.5 rounded-full text-sm">Karyawan</span>
                            </li>
                            <li class="flex justify-between">
                                <span class="text-text-secondary dark:text-dark-text-secondary">Rentang Umur:</span>
                                <span class="font-medium text-text-primary dark:text-dark-text-primary">21-30</span>
                            </li>
                            <li class="flex justify-between">
                                <span class="text-text-secondary dark:text-dark-text-secondary">Sesi Terakhir:</span>
                                <span class="font-medium text-text-primary dark:text-dark-text-primary">3 hari lalu</span>
                            </li>
                        </ul>
                    </div>

                    <!-- POIN 9: Panel Kontrol -->
                    <div class="md:col-span-5 bg-pastel-card dark:bg-dark-card p-6 rounded-2xl shadow-lg card-hover">
                        <h3 class="text-lg font-semibold mb-4 text-pastel-primary">Panel Kontrol Sesi</h3>
                        <div class="flex space-x-3 mb-3">
                            <!-- Tambahkan class disabled untuk styling saat nonaktif -->
                            <button id="btn-start" class="flex-1 bg-pastel-secondary hover:bg-green-300 text-green-900 font-semibold py-3 px-4 rounded-lg shadow transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">Mulai Sesi</button>
                            <button id="btn-pause" class="flex-1 bg-pastel-warn hover:bg-yellow-300 text-yellow-900 font-semibold py-3 px-4 rounded-lg shadow transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed" disabled>Jeda</button>
                            <button id="btn-stop" class="flex-1 bg-pastel-danger hover:bg-red-300 text-red-900 font-semibold py-3 px-4 rounded-lg shadow transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed" disabled>Hentikan</button>
                        </div>
                        <select class="w-full p-3 border border-gray-200 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-700 dark:text-white">
                            <option>Ganti Modul: Pernapasan Dalam (10 mnt)</option>
                            <option>Ganti Modul: Relaksasi Pantai (15 mnt)</option>
                            <option>Ganti Modul: Hutan Tenang (10 mnt)</option>
                        </select>
                    </div>

                    <!-- POIN 8: Alert & Safety Monitoring -->
                    <div class="md:col-span-3 bg-red-100 dark:bg-red-900 border border-pastel-danger dark:border-red-700 p-6 rounded-2xl shadow-lg card-hover">
                        <h3 class="text-lg font-semibold mb-4 text-red-700 dark:text-red-300">Peringatan Keamanan</h3>
                        <div id="alert-list" class="space-y-3 max-h-32 overflow-y-auto">
                            <div class="flex items-center p-3 bg-white dark:bg-dark-card rounded-lg shadow-sm">
                                <svg class="w-5 h-5 text-yellow-500 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 3.001-1.742 3.001H4.42c-1.53 0-2.493-1.667-1.743-3.001l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg>
                                <span class="text-sm dark:text-dark-text-primary">Motion sickness terdeteksi ringan.</span>
                            </div>
                            <!-- Peringatan baru akan ditambahkan oleh JS -->
                        </div>
                    </div>

                    <!-- POIN 3: Status Sesi Real-Time (DIPERBARUI) -->
                    <div class="md:col-span-8 bg-pastel-card dark:bg-dark-card p-6 rounded-2xl shadow-lg card-hover">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-pastel-primary">Status Sesi Real-Time</h3>
                            <div id="live-indicator-wrapper" class="flex items-center space-x-2">
                                <div id="live-indicator" class="w-3 h-3 bg-gray-400 rounded-full transition-colors duration-300"></div>
                                <span id="live-indicator-text" class="text-sm font-medium text-text-secondary dark:text-dark-text-secondary">Tidak Aktif</span>
                            </div>
                        </div>
                        
                        <div class="h-48 mb-4">
                            <canvas id="liveStatusChart"></canvas>
                        </div>
                        
                        <!-- Data Live Lainnya (DIPERBARUI) -->
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                            <div>
                                <div class="text-sm text-text-secondary dark:text-dark-text-secondary">Modul Aktif</div>
                                <div id="live-module" class="text-md font-semibold dark:text-dark-text-primary">--</div>
                            </div>
                            <div>
                                <div class="text-sm text-text-secondary dark:text-dark-text-secondary">Sisa Waktu</div>
                                <div id="live-time" class="text-md font-semibold dark:text-dark-text-primary">--:--</div>
                            </div>
                            <div>
                                <div class="text-sm text-text-secondary dark:text-dark-text-secondary">Pernapasan</div>
                                <div id="live-breath" class="text-md font-semibold dark:text-dark-text-primary">-- bpm</div>
                            </div>
                            <div>
                                <div class="text-sm text-text-secondary dark:text-dark-text-secondary">Detak Jantung</div>
                                <div id="live-heart" class="text-md font-semibold dark:text-dark-text-primary">-- bpm</div>
                            </div>
                            <div>
                                <div class="text-sm text-text-secondary dark:text-dark-text-secondary">Status Stres</div>
                                <div class="flex items-center">
                                    <span id="live-stress-badge" class="px-2 py-0.5 rounded-full text-sm font-medium bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-300">--</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- POIN 2 & 4: Self-Assessment (Before & After) -->
                    <div class="md:col-span-4 bg-pastel-card dark:bg-dark-card p-6 rounded-2xl shadow-lg card-hover">
                        <h3 class="text-lg font-semibold mb-4 text-pastel-primary">Hasil Sesi (Sebelum vs Sesudah)</h3>
                        <div class="flex justify-between items-baseline mb-2">
                            <span class="text-sm text-text-secondary dark:text-dark-text-secondary">Perubahan Total Skor:</span>
                            <span class="text-xl font-bold text-green-600">+40%</span>
                        </div>
                        <div class="h-64">
                             <canvas id="beforeAfterChart"></canvas>
                        </div>
                    </div>

                    <!-- POIN 6: Data Riwayat Pengguna -->
                    <div class="md:col-span-5 bg-pastel-card dark:bg-dark-card p-6 rounded-2xl shadow-lg card-hover">
                        <h3 class="text-lg font-semibold mb-4 text-pastel-primary">Tren Riwayat (30 Hari)</h3>
                         <div class="h-48">
                            <canvas id="historyTrendChart"></canvas>
                        </div>
                    </div>

                    <!-- POIN 5: Insight Otomatis -->
                    <div class="md:col-span-3 bg-pastel-card dark:bg-dark-card p-6 rounded-2xl shadow-lg card-hover">
                        <h3 class="text-lg font-semibold mb-4 text-pastel-primary">Insight Otomatis</h3>
                        <ul class="space-y-3">
                            <li class="flex items-start">
                                <svg class="w-5 h-5 text-green-500 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                                <span class="text-sm dark:text-dark-text-primary">Penurunan stres: 40% (Sangat Efektif).</span>
                            </li>
                            <li class="flex items-start">
                                <svg class="w-5 h-5 text-blue-500 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>
                                <span class="text-sm dark:text-dark-text-primary">Rekomendasi: Lanjutkan modul pernapasan 5 menit.</span>
                            </li>
                        </ul>
                    </div>

                    <!-- POIN 7: Catatan Psikolog -->
                    <div class="md:col-span-4 bg-pastel-card dark:bg-dark-card p-6 rounded-2xl shadow-lg card-hover">
                        <h3 class="text-lg font-semibold mb-4 text-pastel-primary">Catatan Klinis</h3>
                        <textarea id="notes-textarea" class="w-full h-24 p-3 border border-gray-200 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-700 dark:text-white mb-3" placeholder="Tulis catatan singkat..."></textarea>
                        <div class="flex flex-wrap gap-2">
                            <button class="btn-template text-xs bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-text-secondary dark:text-dark-text-secondary px-3 py-1 rounded-full" data-template="Intervensi berhasil, pengguna menunjukkan respons positif.">Intervensi berhasil</button>
                            <button class="btn-template text-xs bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-text-secondary dark:text-dark-text-secondary px-3 py-1 rounded-full" data-template="Anxiety ringan terdeteksi, perlu pemantauan lebih lanjut.">Anxiety ringan</button>
                            <button class="btn-template text-xs bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-text-secondary dark:text-dark-text-secondary px-3 py-1 rounded-full" data-template="Jadwalkan sesi tambahan minggu depan untuk follow-up.">Sesi tambahan</button>
                        </div>
                    </div>

                </div>
            </div>
        </main>
    </div>

    <!-- ===== MODAL KONFIRMASI HENTIKAN SESI ===== -->
    <div id="stop-session-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden transition-opacity duration-300">
        <div class="bg-pastel-card dark:bg-dark-card p-8 rounded-2xl shadow-2xl w-full max-w-md m-4 transform transition-all duration-300 scale-95 opacity-0" id="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-pastel-danger">Hentikan Sesi</h3>
                <button id="cancel-stop-btn-icon" class="text-text-secondary dark:text-dark-text-secondary hover:text-text-primary dark:hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <p class="text-text-secondary dark:text-dark-text-secondary mb-6">Apakah Anda yakin ingin menghentikan sesi ini secara paksa? Tindakan ini akan mengakhiri simulasi VR untuk pengguna.</p>
            <div class="flex justify-end space-x-4">
                <button id="cancel-stop-btn" class="py-2 px-5 bg-gray-200 dark:bg-gray-700 text-text-primary dark:text-dark-text-primary font-semibold rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition duration-200">Batal</button>
                <button id="confirm-stop-btn" class="py-2 px-5 bg-pastel-danger text-red-900 font-semibold rounded-lg hover:bg-red-300 transition duration-200">Ya, Hentikan Sesi</button>
            </div>
        </div>
    </div>


    <!-- ===== JAVASCRIPT ===== -->
    <script type="module">
        // Variabel global untuk simulasi
        let liveChart;
        let sessionInterval = null;
        let sessionTimeSeconds = 600; // 10 menit
        const responses = ["Rileks", "Tenang", "Agak Tegang", "Rileks", "Fokus"];
        const motions = ["Optimal", "Baik", "Cukup", "Optimal"];

        // Elemen UI
        const btnStart = document.getElementById('btn-start');
        const btnPause = document.getElementById('btn-pause');
        const btnStop = document.getElementById('btn-stop');
        
        const liveIndicator = document.getElementById('live-indicator');
        const liveIndicatorText = document.getElementById('live-indicator-text');
        const liveModule = document.getElementById('live-module');
        const liveTime = document.getElementById('live-time');
        const liveBreath = document.getElementById('live-breath');
        const liveHeart = document.getElementById('live-heart');
        const liveStressBadge = document.getElementById('live-stress-badge');
        
        const stopModal = document.getElementById('stop-session-modal');
        const modalContent = document.getElementById('modal-content');
        const confirmStopBtn = document.getElementById('confirm-stop-btn');
        const cancelStopBtn = document.getElementById('cancel-stop-btn');
        const cancelStopBtnIcon = document.getElementById('cancel-stop-btn-icon');
        
        const themeToggleBtn = document.getElementById('theme-toggle');
        const sunIcon = document.getElementById('theme-icon-sun');
        const moonIcon = document.getElementById('theme-icon-moon');

        // --- Inisialisasi Saat DOM Siap ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("Dashboard Ruang Pulih (Pro) Dimuat.");

            initLiveStatusChart();
            initBeforeAfterChart();
            initHistoryTrendChart();

            setupControls();
            setupNoteTemplates();
            setupThemeToggle();
            setupModal();

            simulateAlerts();
        });

        // --- POIN 3: Grafik & Simulasi Live (DIPERBARUI) ---
        function initLiveStatusChart() {
            const ctx = document.getElementById('liveStatusChart').getContext('2d');
            
            liveChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array(20).fill(''), // 20 titik data
                    datasets: [
                        {
                            label: 'Pernapasan (bpm)',
                            data: Array(20).fill(null), // Mulai kosong
                            borderColor: '#a0c4ff', // Pastel Biru
                            borderWidth: 3,
                            pointRadius: 0,
                            tension: 0.4,
                            fill: true,
                            backgroundColor: (context) => {
                                const gradient = context.chart.ctx.createLinearGradient(0, 0, 0, 150);
                                gradient.addColorStop(0, 'rgba(160, 196, 255, 0.6)');
                                gradient.addColorStop(1, 'rgba(160, 196, 255, 0.1)');
                                return gradient;
                            },
                        },
                        {
                            label: 'Detak Jantung (bpm)',
                            data: Array(20).fill(null), // Mulai kosong
                            borderColor: '#ffcda3', // Pastel Peach
                            borderWidth: 3,
                            pointRadius: 0,
                            tension: 0.4,
                            fill: true,
                            backgroundColor: (context) => {
                                const gradient = context.chart.ctx.createLinearGradient(0, 0, 0, 150);
                                gradient.addColorStop(0, 'rgba(255, 205, 163, 0.6)');
                                gradient.addColorStop(1, 'rgba(255, 205, 163, 0.1)');
                                return gradient;
                            },
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    scales: {
                        x: { display: false },
                        y: { 
                            display: true, 
                            min: 0, 
                            max: 100, // Range lebih besar untuk detak jantung
                            grid: { drawBorder: false, color: 'rgba(128, 128, 128, 0.1)' } 
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    },
                    tooltips: { enabled: false }
                }
            });
        }
        
        // --- POIN 9: Fungsionalitas Kontrol (DIPERBARUI) ---
        function setupControls() {
            btnStart.addEventListener('click', startSession);
            btnPause.addEventListener('click', pauseSession);
            btnStop.addEventListener('click', showStopModal);
        }

        function startSession() {
            if (sessionInterval) return; // Sudah berjalan
            
            console.log("Sesi Dimulai");
            liveIndicator.className = 'w-3 h-3 bg-red-500 rounded-full animate-pulse';
            liveIndicatorText.innerText = 'LIVE';
            liveModule.innerText = 'Pernapasan Dalam';

            // Update status tombol
            btnStart.disabled = true;
            btnPause.disabled = false;
            btnStop.disabled = false;

            // Isi data awal untuk grafik
            liveChart.data.datasets[0].data = Array(20).fill(null).map(() => Math.random() * 5 + 5);
            liveChart.data.datasets[1].data = Array(20).fill(null).map(() => Math.random() * 10 + 65);
            liveChart.update();

            // Mulai interval simulasi (HANYA SATU)
            sessionInterval = setInterval(runSessionSimulation, 1000); // Update setiap 1 dtk
        }

        function pauseSession() {
            if (!sessionInterval) return; // Tidak sedang berjalan
            
            console.log("Sesi Dijeda");
            clearInterval(sessionInterval);
            sessionInterval = null;

            liveIndicator.className = 'w-3 h-3 bg-yellow-500 rounded-full';
            liveIndicatorText.innerText = 'Dijeda';

            // Update status tombol
            btnStart.disabled = false;
            btnPause.disabled = true;
            btnStop.disabled = false;
        }

        function stopSession() {
            console.log("Sesi Dihentikan");
            clearInterval(sessionInterval);
            sessionInterval = null;
            sessionTimeSeconds = 600; // Reset waktu

            liveIndicator.className = 'w-3 h-3 bg-gray-400 rounded-full';
            liveIndicatorText.innerText = 'Tidak Aktif';
            liveTime.innerText = '--:--';
            liveModule.innerText = '--';
            liveBreath.innerText = '-- bpm';
            liveHeart.innerText = '-- bpm';
            liveStressBadge.innerText = '--';
            liveStressBadge.className = 'px-2 py-0.5 rounded-full text-sm font-medium bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-300';
            
            // Kosongkan grafik
            liveChart.data.datasets[0].data = Array(20).fill(null);
            liveChart.data.datasets[1].data = Array(20).fill(null);
            liveChart.update();

            // Update status tombol
            btnStart.disabled = false;
            btnPause.disabled = true;
            btnStop.disabled = true;
        }

        // --- Fungsi Simulasi Utama (BARU) ---
        function runSessionSimulation() {
            // 1. Update Waktu
            sessionTimeSeconds--;
            const minutes = Math.floor(sessionTimeSeconds / 60);
            const seconds = sessionTimeSeconds % 60;
            liveTime.innerText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // 2. Hasilkan Data Baru
            const newBreathData = Math.random() * 5 + 5; // 5-10 bpm
            const newHeartData = Math.random() * 10 + 65; // 65-75 bpm

            // 3. Update Grafik
            liveChart.data.datasets[0].data.push(newBreathData);
            liveChart.data.datasets[0].data.shift();
            liveChart.data.datasets[1].data.push(newHeartData);
            liveChart.data.datasets[1].data.shift();
            liveChart.update();

            // 4. Update Teks Metrik
            liveBreath.innerText = `${newBreathData.toFixed(1)} bpm`;
            liveHeart.innerText = `${newHeartData.toFixed(1)} bpm`;

            // 5. Update Status Stres (setiap 3 detik)
            if (sessionTimeSeconds % 3 === 0) {
                updateStressStatus(newHeartData, newBreathData);
            }
            
            // 6. Cek Selesai
            if (sessionTimeSeconds <= 0) {
                stopSession();
                // Ganti ini dengan modal "Sesi Selesai"
                console.log("Sesi Selesai!"); 
            }
        }
        
        function updateStressStatus(heart, breath) {
            if (heart > 72 || breath > 8) {
                liveStressBadge.innerText = 'Waspada';
                liveStressBadge.className = 'px-2 py-0.5 rounded-full text-sm font-medium bg-pastel-warn text-yellow-900';
            } else if (heart < 68 && breath < 6) {
                liveStressBadge.innerText = 'Tenang';
                liveStressBadge.className = 'px-2 py-0.5 rounded-full text-sm font-medium bg-pastel-secondary text-green-900';
            } else {
                liveStressBadge.innerText = 'Normal';
                liveStressBadge.className = 'px-2 py-0.5 rounded-full text-sm font-medium bg-blue-200 text-blue-900';
            }
        }


        // --- POIN 8: Modal Konfirmasi (BARU) ---
        function setupModal() {
            cancelStopBtn.addEventListener('click', hideStopModal);
            cancelStopBtnIcon.addEventListener('click', hideStopModal);
            confirmStopBtn.addEventListener('click', () => {
                hideStopModal();
                stopSession(); // Panggil fungsi stop yang sebenarnya
            });
            
            // Klik di luar modal untuk menutup
            stopModal.addEventListener('click', (e) => {
                if (e.target === stopModal) {
                    hideStopModal();
                }
            });
        }
        
        function showStopModal() {
            stopModal.classList.remove('hidden');
            stopModal.classList.add('flex');
            // Animasikan modal masuk
            setTimeout(() => {
                stopModal.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10); // delay kecil untuk memulai transisi
        }

        function hideStopModal() {
            // Animasikan modal keluar
            stopModal.classList.add('opacity-0');
            modalContent.classList.add('scale-95', 'opacity-0');
            modalContent.classList.remove('scale-100', 'opacity-100');
            
            setTimeout(() => {
                stopModal.classList.add('hidden');
                stopModal.classList.remove('flex');
            }, 300); // Sesuaikan dengan durasi transisi
        }

        // --- POIN 2 & 4: Grafik Before/After ---
        function initBeforeAfterChart() {
            const ctx = document.getElementById('beforeAfterChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Stres', 'Mood', 'Ketegangan'],
                    datasets: [
                        { label: 'Sebelum', data: [4, 2, 4.5], backgroundColor: '#ffcda3', borderRadius: 6 },
                        { label: 'Sesudah', data: [1.5, 3, 2], backgroundColor: '#b6e2d3', borderRadius: 6 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, max: 5 } },
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        // --- POIN 6: Grafik Tren Riwayat ---
        function initHistoryTrendChart() {
            const ctx = document.getElementById('historyTrendChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Sesi 1', 'Sesi 2', 'Sesi 3', 'Sesi 4', 'Sesi 5', 'Sesi 6'],
                    datasets: [
                        { label: 'Tren Stres (Skor)', data: [4.5, 4.0, 3.8, 3.0, 2.5, 1.5], borderColor: '#ffadad', tension: 0.3, fill: false },
                        { label: 'Tren Mood (Skor)', data: [1.5, 2.0, 1.8, 2.5, 2.8, 3.0], borderColor: '#a0c4ff', tension: 0.3, fill: false }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, max: 5 } },
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }
        
        // --- POIN 7: Template Catatan Klinis ---
        function setupNoteTemplates() {
            const textarea = document.getElementById('notes-textarea');
            document.querySelectorAll('.btn-template').forEach(button => {
                button.addEventListener('click', () => {
                    textarea.value = button.dataset.template;
                });
            });
        }
        
        // --- POIN 8: Simulasi Peringatan ---
        function simulateAlerts() {
            setTimeout(() => {
                const alertList = document.getElementById('alert-list');
                const newAlert = document.createElement('div');
                newAlert.className = 'flex items-center p-3 bg-red-200 dark:bg-red-800 border border-red-400 dark:border-red-600 rounded-lg shadow-sm animate-pulse';
                newAlert.innerHTML = `
                    <svg class="w-5 h-5 text-red-700 dark:text-red-300 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v4a1 1 0 102 0V7zm-1 9a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path></svg>
                    <span class="text-sm font-semibold text-red-800 dark:text-red-200">Sesi berhenti mendadak!</span>
                `;
                alertList.prepend(newAlert);
            }, 10000); // Muncul setelah 10 detik
        }
        
        // --- Fungsi Dark Mode Toggle (BARU) ---
        function setupThemeToggle() {
            // Cek tema saat load
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
                moonIcon.classList.remove('hidden');
                sunIcon.classList.add('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            }

            themeToggleBtn.addEventListener('click', () => {
                // Toggle tema
                if (document.documentElement.classList.contains('dark')) {
                    document.documentElement.classList.remove('dark');
                    localStorage.theme = 'light';
                    sunIcon.classList.remove('hidden');
                    moonIcon.classList.add('hidden');
                } else {
                    document.documentElement.classList.add('dark');
                    localStorage.theme = 'dark';
                    moonIcon.classList.remove('hidden');
                    sunIcon.classList.add('hidden');
                }
            });
        }

    </script>
</body>
</html>
